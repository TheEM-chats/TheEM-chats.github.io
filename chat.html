<!DOCTYPE html>
<html lang="ru">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    html,
    body {
        overflow: hidden;
        /* Полностью убираем скролл у окна */
        height: 100%;
    }
    
    #myContainer {
        overflow-y: scroll;
        height: 300px;
    }
    
    #myContainer::-webkit-scrollbar {
        width: 4px;
    }
    
    #myContainer::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #myContainer::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
    }
</style>

<head>
    <meta charset="UTF-8" />
    <title>TheEM - чат</title>
    <!-- Подключаем библиотеку p5.js и расширение p5.dom -->

    <script src="libs/p5.js"></script>
    <script src="libs/xlibs.js"></script>
    <script src="chat/render.js"></script>
    <script src="chat/menu.js"></script>
    <script src="homepage/load_chats.js"></script>
    <script src="chat/usrader.js"></script>
    <script src="chat/usrlist.js"></script>

</head>

<body>
    <script>
        let inputBIG = false

        var ss = getCookie("ss")
        var pp = getCookie("pp");
        let ps = getCookie("ps")
        let target = getCookie("target")
        let name = getCookie("name")
        var chatid = getCookie("chatid")
        let globalres = ""
        let history = []
        let objs = []
        let adds = []
        let subut
        let container
        let btnCancel
        let btnDelete
        let btnEdit
        let btnOpen
        let btnText
        let msgs = 1
        let timer1 = 1
        let lastmsg
        let editmenu = 0
        let joiningcall

        var level
        let displaylevel
        var andpass = "&pass=" + ps
        var targ2 = target


        let autors = new Map();
        var bans = []
        var ids = []
        let passSec = false

        var syssent;


        function getAutor(autid) {
            if (autors.get(autid) != autors.get("id375nonononono")) {
                console.log("Уже сохранено!")
                return autors.get(autid)
            } else {
                console.log("Поиск в интернете")
                autors.set(autid, "Загрузка...")
                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + autid + "_profn")
                    .then(response => response.text())
                    .then(data => {
                        if (autors.get(autid) == autors.get("id375nonononono") || autors.get(autid) == "Загрузка...") {
                            ids.push(autid)
                            console.log(ids)
                        }
                        autors.set(autid, data)
                        render()
                    })
                    .catch(error => {
                        autors.set(autid, "?")
                    });
                return "Загрузка..."
            }
        }

        function setup() {
            BackStyling()
                //Проверка уровня 3 - Гл Админ | 2 - Модер | 1 - Учасник | 0 - Это обычный чат
            statusButton = createButton("Загрузка статуса {[ТЫК ДЛЯ БОЛЬШЕГО]}")
            ButtonStyling(statusButton)
            statusButton.style('border-radius', '7px')
            statusButton.position(0, 38)
            statusButton.size(window.innerWidth - 80, 20)
            statusButton.mousePressed(() => {
                if (level != 0) {
                    console.log("Нажато");
                    listrender();
                }

            });

            function passSec_func() {
                if (!passSec) {
                    passSec = true
                    fetch("https://sebain.pythonanywhere.com/updatepass?filename=chat_" + chatid + "&2pass=" + pp + "&new2pass=" + ps)
                        .then(response => response.text())
                        .then(data => {
                            fetch("https://sebain.pythonanywhere.com/updatepass?filename=" + chatid + "_ignore&2pass=" + pp + "&new2pass=" + ps)
                                .then(response => response.text())
                                .then(data => {
                                    console.log("Пароли обновились!")
                                })
                                .catch(error => {
                                    console.error("Ошибка при получении данных:", error);
                                });
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                        });

                }
            }

            function reloadStatus() {
                if (target == "channel" || target == "group") {
                    fetch("https://sebain.pythonanywhere.com/get?filename=" + chatid + "_owner")
                        .then(response => response.text())
                        .then(data => {
                            let arr = JSON.parse(data)
                            if (arr[0] == pp) {
                                //Наш уровень 3
                                level = 3
                                if (target == "channel") {
                                    displaylevel = "[КАНАЛ] [ГЛ АДМИН]"
                                    statusButton.html(displaylevel + " {[ТЫК ДЛЯ БОЛЬШЕГО]}")
                                } else {
                                    displaylevel = "[ГРУППА] [ГЛ АДМИН]"
                                    statusButton.html(displaylevel + " {[ТЫК ДЛЯ БОЛЬШЕГО]}")
                                }
                            } else {
                                num = arr.length - 1
                                let found = false
                                while (num > -1) {
                                    if (arr[num] == pp) {
                                        //Наш уровень 2
                                        found = true
                                        level = 2
                                        passSec_func()
                                        if (target == "channel") {
                                            displaylevel = "[КАНАЛ] [МОДЕР]"
                                            statusButton.html(displaylevel + " {[ТЫК ДЛЯ БОЛЬШЕГО]}")
                                        } else {
                                            displaylevel = "[ГРУППА] [МОДЕР]"
                                            statusButton.html(displaylevel + " {[ТЫК ДЛЯ БОЛЬШЕГО]}")
                                        }
                                    }
                                    num--
                                }
                                if (!found) {
                                    //Наш уровень 1
                                    level = 1
                                    if (target == "channel") {
                                        displaylevel = "[КАНАЛ] [УЧАСНИК]"
                                        statusButton.html(displaylevel + " {[ТЫК ДЛЯ БОЛЬШЕГО]}")
                                    } else {
                                        displaylevel = "[ГРУППА] [УЧАСНИК]"
                                        statusButton.html(displaylevel + " {[ТЫК ДЛЯ БОЛЬШЕГО]}")
                                    }
                                }
                            }
                            updatebanlist()


                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                        });
                } else {
                    //Наш уровень
                    level = 0
                    displaylevel = "[ЧАТ] [НЕТ АДМИНОВ]"
                    statusButton.html(displaylevel)
                    updatebanlist()
                }
            }
            reloadStatus()

            overlay = createButton("")
            overlay.position(0, 0);
            overlay.size(windowWidth, windowHeight);
            overlay.style('background', 'rgba(0, 0, 0, 0.6)');
            overlay.style('position', 'fixed');
            overlay.style('z-index', '5');
            overlay.style('pointer-events', 'auto');
            overlay.mousePressed(() => {
                console.log("На оверлей тыкать низя!")
            });
            if (getCookie("IsReg") != "1" || getCookie("name") == getCookie("ываываывауцкцуквпыпewwerwr") || getCookie("name") == "undefined") {
                window.location.href = "homepage.html";
            }


            overlay.hide()
            setInterval(() => {
                timer1++
                if (timer1 == 16) {
                    timer1 = 1
                    msgs = 0
                }
                if (msgs > 7) {
                    alert("НЕ ОТПРАВЛЯЙТЕ МНОГО СООБЩЕНИЙ, ИНАЧЕ БУДЕТ СЛОЖНАЯ КАПТЧА")
                }
                if (msgs > 10) {
                    setCookie2("captcha", "yes")
                    window.location.href = "captcha.html"
                }
                console.log(timer1)
                console.log(msgs)

            }, 1000);
            //Отправка вложений - картинка
            function fileToBase64(file, callback) {
                const reader = new FileReader();
                reader.onload = function() {
                    callback(reader.result);
                };
                reader.onerror = function() {
                    console.error('Ошибка чтения файла');
                };
                reader.readAsDataURL(file);
            }

            function compressImage(file, maxSizeBytes, callback) {
                const img = new Image();
                const url = URL.createObjectURL(file);

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    let quality = 0.95;

                    function tryCompress() {
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        const byteLength = atob(dataUrl.split(',')[1]).length;

                        if (byteLength <= maxSizeBytes || quality < 0.1) {
                            fetch(dataUrl)
                                .then(res => res.blob())
                                .then(blob => {
                                    const newFile = new File([blob], file.name, {
                                        type: 'image/jpeg'
                                    });
                                    callback(newFile);
                                });
                        } else {
                            quality -= 0.05;
                            tryCompress();
                        }
                    }

                    tryCompress();
                };

                img.onerror = function() {
                    callback(null);
                };

                img.src = url;
            }

            function imgsent(file) {
                const MAX_SIZE_MB = 30;
                const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;

                if (!file.type.startsWith('image/')) {
                    console.error('Файл не является изображением');
                    return;
                }

                compressImage(file, MAX_SIZE_BYTES, function(compressedFile) {
                    if (!compressedFile) {
                        console.error('Не удалось сжать изображение до 30 МБ');
                        alert("Большой файл, не больше 30 мб!")
                        return;
                    }

                    fileToBase64(compressedFile, function(base64) {
                        const apiKey = 'c77c07592cd1f730aacfb02824de3a17'; // ← Вставь свой API ключ с imgbb
                        const formData = new FormData();
                        formData.append('image', base64.split(',')[1]);

                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', 'https://api.imgbb.com/1/upload?key=' + apiKey, true);

                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                const result = JSON.parse(xhr.responseText);
                                if (result.success) {
                                    const url = result.data.url;
                                    console.log('Ссылка на изображение:', url);
                                    history.push({
                                        type: 'img',
                                        value: url,
                                        sender: pp,
                                        time: Math.floor(Date.now() / 1000),
                                        uid: getRandomFromRange(111111, 999999)
                                    });
                                    push()
                                } else {
                                    console.error('Ошибка загрузки:', result);
                                }
                            } else {
                                console.error('Ошибка запроса:', xhr.statusText);
                            }
                        };

                        xhr.onerror = function() {
                            console.error('Ошибка сети');
                        };

                        xhr.send(formData);
                    });
                });
            }

            function filesent(file, zagolov) {
                const formData = new FormData();
                formData.append('file', file);

                // 🎚️ Прогресс-бар + проценты
                const overlay = createDiv();
                overlay.style(`
                  position: fixed;
                  top: 0; left: 0;
                  width: 100vw; height: 100vh;
                  background: rgba(0,0,0,0.6);
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  z-index: 1000;
                `);
                overlay.parent(document.body);

                const progressBar = createElement('progress', '0');
                progressBar.attribute('max', '100');
                progressBar.style('width: 400px; height: 30px;');
                progressBar.parent(overlay);

                const percentText = createP('0%');
                percentText.style('color: white; font-size: 24px; margin-top: 10px;');
                percentText.parent(overlay);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://sebain.pythonanywhere.com/upload_catbox', true);

                xhr.upload.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        progressBar.value(percent);
                        percentText.html(percent + '%');
                    }
                };

                xhr.onload = function() {
                    // Загрузка на Catbox завершена — можно убрать
                    const response = JSON.parse(xhr.responseText);
                    console.log('Файл загружен:', response.url);
                    percentText.html('Готово!');
                    setTimeout(() => overlay.remove(), 1000);
                    input.value("")
                    history.push({
                        type: 'file',
                        value: response.url,
                        sender: pp,
                        time: Math.floor(Date.now() / 1000),
                        uid: getRandomFromRange(111111, 999999),
                        header: zagolov
                    });
                    push()
                };

                xhr.onerror = function() {
                    percentText.html('Ошибка!');
                    setTimeout(() => overlay.remove(), 1500);
                    console.error('Ошибка загрузки');
                };

                xhr.send(formData);
            }

            //Отправка вложений - фунция
            function vlog() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*/*';

                input.onchange = () => {
                    const file = input.files[0];
                    if (!file) return;

                    const mimeType = file.type;
                    let fileType;
                    const fsize = (file.size / (1024 * 1024)).toFixed(2); // в мегабайтах
                    if (mimeType.startsWith('image/')) {
                        fileType = 'img';
                        if (fsize < 30) {
                            imgsent(file)
                        } else {
                            alerterr("Большой вес, не более 30 мб")
                        }

                    } else if (mimeType.startsWith('video/')) {
                        fileType = 'vid';
                        if (fsize < 200) {
                            filesent(file, "Видео")
                        } else {
                            alerterr("Большой вес, не более 200 мб")
                        }
                    } else {
                        fileType = 'oth';
                        if (fsize < 200) {
                            filesent(file, "Не опознанный файл")
                        } else {
                            alerterr("Большой вес, не более 200 мб")
                        }
                    }
                    console.log(fileType)
                };
                input.click();
            }

            function push() {
                xpush(pxsentpush)
            }

            function pxsentpush() {
                console.log("Кол-бек от xpush и push принят(успешно)")
            }


            function xpush(callback) {
                if (lastmsg == history[history.length - 1].value) {
                    history.splice(history.length - 1, 1);
                } else {
                    lastmsg = history[history.length - 1].value;
                    msgs++;
                    SoundEffect("push.mp3");
                    historyP = history[history.length - 1];
                    let pushing = JSON.stringify(historyP);
                    console.log(pushing);
                    fetch("https://sebain.pythonanywhere.com/push?filename=chat_" + getCookie("chatid") + "&text=" + Crypt(pushing) + andpass)
                        .then(response => response.text())
                        .then(data => {
                            console.log("Загрузка " + data);
                            render();
                            callback()
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                        });
                }
            }

            function pushAll() {
                msgs++;
                SoundEffect("push.mp3");

                let pushing = JSON.stringify(history);
                let payload = {
                    filename: "chat_" + getCookie("chatid"),
                    text: pushing
                };

                fetch("https://sebain.pythonanywhere.com/set_post", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.text())
                    .then(data => {
                        console.log("Загрузка " + data);
                        render();
                    })
                    .catch(error => {
                        console.error("Ошибка при получении данных:", error);
                    });
            }


            syssent = function(message) {
                input.value("")
                history.push({
                    type: 'text',
                    value: message,
                    sender: "system",
                    time: Math.floor(Date.now() / 1000),
                    uid: getRandomFromRange(111111, 999999)
                });
                push()
            };

            noCanvas(); // отключаем холст, если он не нужен
            function filterTextWithBanwords(inputText) {
                if (banwords.size === 0) {
                    console.warn('Список banwords ещё не загружен');
                    return inputText;
                }

                // Разбиваем на слова, пробелы и знаки препинания
                const tokens = inputText.match(/[\wа-яА-ЯёЁ]+|[^\w\s]|[\s]+/g);

                const filtered = tokens.map(token => {
                    const normalized = token.toLowerCase().replace(/[^а-яa-z0-9]/gi, '');
                    return banwords.has(normalized) ? '(мат)' : token;
                });

                return filtered.join('');
            }


            function updatebanlist() {
                fetch("https://sebain.pythonanywhere.com/get?filename=" + chatid + "_ignore")
                    .then(response => response.text())
                    .then(data => {
                        bans = JSON.parse(data)
                        if (ismuted(pp) || (target == "channel" && level == 1)) {
                            input.hide()
                            fileS.hide()
                            send.hide()
                            call.hide()
                        } else {
                            try {
                                input.show()
                                fileS.show()
                                send.show()
                                call.show()
                            } catch {
                                console.log("Связь чинить не надо!")
                            }

                        }
                        if (isbanned(pp)) {
                            banrem(false)
                        }
                    })
                    .catch(error => {
                        if (target == "channel" && level == 1) {
                            input.hide()
                            fileS.hide()
                            send.hide()
                            call.hide()
                        } else {
                            try {
                                input.show()
                                fileS.show()
                                send.show()
                                call.show()
                            } catch {
                                console.log("Связь чинить не надо!")
                            }

                        }
                    });
            }

            // Загружаем banwords.txt при старте
            fetch('/banword.txt')
                .then(res => res.text())
                .then(text => {
                    text
                        .split(/\r?\n/)
                        .map(w => w.trim().toLowerCase())
                        .forEach(w => {
                            if (w.length > 0) banwords.add(w);
                        });
                    console.log(`Загружено ${banwords.size} запрещённых слов`);
                    update()
                    updatebanlist()

                });

            function reloadOnline() {
                if (level == 0) {
                    fetch("https://sebain.pythonanywhere.com/saveget?filename=" + getCookie("target") + "_last-online&text=" + Math.floor(Date.now() / 1000))
                        .then(response => response.text())
                        .then(data => {
                            let dif1 = Math.floor(Date.now() / 1000) - data
                            let dstate
                            if (dif1 < 60) {
                                dstate = "В сети";
                            } else if (dif1 < 60 * 2) {
                                dstate = "В сети минуту назад";
                            } else if (dif1 < 60 * 60) {
                                dstate = "В сети " + Math.floor(dif1 / 60) + " минут назад";
                            } else if (dif1 < 60 * 60 * 24) {
                                dstate = "В сети " + Math.floor(dif1 / 60 / 60) + " часов назад";
                            } else {
                                dstate = "В сети " + Math.floor(dif1 / 60 / 60 / 24) + " дней назад";
                            }
                            name.html(getCookie("name") + " (" + dstate + ")")
                        })
                        .catch(error => {
                            name.html(getCookie("name"))
                        });
                } else {
                    name.html(getCookie("name"))
                }

            }
            let found = 0
            setInterval(() => {
                fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_last-online&text=" + Math.floor(Date.now() / 1000))
                    .then(response => response.text())
                    .then(data => {

                    })
                    .catch(error => {

                    });
                updatebanlist()
                reloadOnline()
                reloadStatus()
                console.log("Каждые 7 секунд: пип!");
                update()
                let num = history.length - 1
                if (found == 0) {
                    while (num > -1) {
                        if (history[num].sender == pp) {
                            num = -1000
                            found = 1
                        }
                        num--
                    }
                    if (found == 0) {
                        let placeholder = [{
                            type: 'invis',
                            value: "placeholder for notifications",
                            sender: pp,
                            time: Math.floor(Date.now() / 1000)
                        }];
                        let backpush = JSON.stringify(placeholder)
                        fetch("https://sebain.pythonanywhere.com/backpush?filename=chat_" + getCookie("chatid") + "&text=" + backpush)
                            .then(response => response.text())
                            .then(data => {
                                update()
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    }
                }
            }, 7000)
            container = createDiv();
            container.id('myContainer')
                //container.id("chat-container"); // дадим ID для удобства
            container.style('display', 'flex');
            container.style('flex-direction', 'column');
            container.style('gap', '10px');
            container.style('padding', '20px');
            container.style('overflow', 'auto');
            container.size(window.innerWidth - 45, window.innerHeight - 100)
            container.position(0, 57)
            let exit = createButton("Выход")
            ButtonStyling(exit)
            exit.style('border-radius', '10px')
            exit.mousePressed(() => {
                window.location.href = "homepage.html"

            });
            exit.position(0, 0)
            exit.size(60, 37)
            let name = createP(getCookie("name"))
            name.style('border-radius', '10px')
            ButtonStyling(name)
            name.style('background', "rgba(" + hexToRGBValues(getCookie("colour")) + ", 0.36)");
            name.style('box-shadow', "0 2px 6px rgba(" + hexToRGBValues(getCookie("colour")) + " , 0.30)");

            name.mouseOver(() => {
                name.style('background', "rgba(" + hexToRGBValues(getCookie("colour")) + ", 0.50)");
                name.style('box-shadow', "0 2px 6px rgba(" + hexToRGBValues(getCookie("colour")) + " , 0.50)");
            });

            name.mouseOut(() => {
                name.style('background', "rgba(" + hexToRGBValues(getCookie("colour")) + ", 0.36)");
                name.style('box-shadow', "0 2px 6px rgba(" + hexToRGBValues(getCookie("colour")) + " , 0.30)");
            });
            //name.style('background-color', );
            name.position(60, -15)
            name.size(window.innerWidth - 142, 35)
            reloadOnline()
            let ban = createButton("Удалить!")

            function banrem(state) {
                fetch("https://sebain.pythonanywhere.com/savestget?filename=" + ps + "_chats")
                    .then(response => response.text())
                    .then(data => {
                        let list = JSON.parse(data);
                        const cookieChatId = getCookie('chatid');
                        const cookieIdStr = cookieChatId != null ? String(cookieChatId).trim() : '';

                        newList = list.filter(function(o) {
                            const chatId = (o && o.chatid != null) ? String(o.chatid).trim() : '';
                            return chatId !== cookieIdStr;
                        });

                        const exportJson = JSON.stringify(newList);



                        return fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_chats" + "&text=" + exportJson);
                    })
                    .then(response => response.text())
                    .then(() => {
                        if (state) {
                            history.push({
                                type: 'text',
                                value: pp + " Удалил эту переписку",
                                sender: "system",
                                time: Math.floor(Date.now() / 1000)
                            });

                            SoundEffect("push.mp3");

                            let pushing = JSON.stringify(history);
                            let payload = {
                                filename: "chat_" + getCookie("chatid"),
                                text: pushing
                            };

                            fetch("https://sebain.pythonanywhere.com/set_post", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify(payload)
                                })
                                .then(response => response.text())
                                .then(data => {
                                    console.log("Загрузка" + data);
                                    render();
                                    fetch("https://sebain.pythonanywhere.com/unreg?filename=chat_" + getCookie("chatid") + "&key=" + ps)
                                        .then(response => response.text())
                                        .then(data => {
                                            render()
                                            alert("Удалено!");
                                            window.location.href = "homepage.html";
                                        })
                                        .catch(error => {
                                            console.error("Ошибка при получении данных:", error);
                                        });

                                })
                                .catch(error => {
                                    console.error("Ошибка при получении данных:", error);
                                });
                        } else {
                            window.location.href = "homepage.html";
                        }

                    })
                    .catch(error => {
                        console.error("Ошибка при удалении:", error);
                    });
            }
            ban.mousePressed(() => {
                let confirm = prompt(
                    "Если вы и вправду хотите удалить чат : " + getCookie("name") +
                    ", то просто введи это число: " + getCookie("chatid") + " и нажми ок"
                );

                if (confirm === getCookie("chatid")) {
                    banrem(true)
                }
            })
            ButtonStyling(ban)
            ban.style('border-radius', '10px')
            ban.position(window.innerWidth - 80, 0)
            ban.size(77, 37)
            let call = createButton("Созвон")
            ButtonStyling(call)
            call.style('border-radius', '7px')
            call.position(window.innerWidth - 80, 38)
            call.size(77, 20)
            call.mousePressed(() => {
                if (history[history.length - 1].type != "call") {
                    joiningcall = getRandomFromRange(11111, 99999)
                    history.push({
                        type: 'call',
                        value: "Созвон начат [ЗАЙТИ]",
                        sender: pp,
                        time: Math.floor(Date.now() / 1000),
                        uid: getRandomFromRange(1111111111, 9999999999),
                        callid: joiningcall
                    });
                    xpush(joincall)
                } else {
                    alert("Уже есть активный созвон, зайдите в него!")
                }
            });

            function joincall() {
                setCookie2("callid", joiningcall)
                window.location.href = "call.html"
            }

            function biggerINPUT() {
                if (inputBIG && input.value().length < 16) {
                    inputBIG = false
                    let oldtext = input.value()
                    input.remove();
                    input = createInput(oldtext)
                    ButtonStyling(input)
                    input.attribute('placeholder', 'Введите текст...');
                    input.style('font-size', '16px');

                    input.style('background', "rgba(" + hexToRGBValues("#000000") + ", 0.66)");
                    input.style('box-shadow', "0 2px 6px rgba(" + hexToRGBValues("#000000") + " , 0.60)");
                    input.mouseOver(() => {});
                    input.mouseOut(() => {});
                    input.style('border-radius', '8px')
                    input.input(biggerINPUT)
                    input.elt.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Enter нажат: ' + input.value());
                            sent(input.value())

                        }
                    });
                    input.elt.focus()
                    input.elt.setSelectionRange(15, 15)
                    inputposititoner()
                } else if (!inputBIG && input.value().length > 15) {
                    let currentText = input.value();

                    input.remove();

                    input = createElement('textarea', currentText);
                    ButtonStyling(input)
                    input.attribute('placeholder', 'Введите текст...');
                    input.style('font-size', '12px');

                    input.style('background', "rgba(" + hexToRGBValues("#000000") + ", 0.66)");
                    input.style('box-shadow', "0 2px 6px rgba(" + hexToRGBValues("#000000") + " , 0.60)");
                    input.mouseOver(() => {});
                    input.mouseOut(() => {});
                    input.style('border-radius', '8px')
                    inputBIG = true
                    input.input(biggerINPUT)
                    input.elt.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Enter нажат: ' + input.value());
                            sent(input.value())

                        }
                    });
                    input.elt.focus()
                    input.elt.setSelectionRange(16, 16)
                    inputposititoner()
                }
            }

            function inputposititoner() {
                send.position(window.innerWidth - 65, window.innerHeight - 40)
                sendP.position(window.innerWidth - 61, window.innerHeight - 70)
                fileS.position(window.innerWidth - 105, window.innerHeight - 40)
                fileSP.position(window.innerWidth - 101, window.innerHeight - 63)
                if (inputBIG) {
                    input.position(15, window.innerHeight - 120)
                    input.size(window.innerWidth - 45, 75)
                } else {
                    input.position(15, window.innerHeight - 40)
                    input.size(window.innerWidth - 45, 30)
                }
            }
            //Начало над полевводные кнопки и инпут
            window.addEventListener("resize", () => {
                inputposititoner()
                BackStyling()
            });
            var input = createInput()
            ButtonStyling(input)
            input.attribute('placeholder', 'Введите текст...');
            input.style('font-size', '16px');
            input.style('background', "rgba(" + hexToRGBValues("#000000") + ", 0.66)");
            input.style('box-shadow', "0 2px 6px rgba(" + hexToRGBValues("#000000") + " , 0.60)");
            input.mouseOver(() => {});
            input.mouseOut(() => {});
            input.style('border-radius', '8px')
            input.input(biggerINPUT)
            input.elt.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    console.log('Enter нажат: ' + input.value());
                    sent(input.value())

                }
            });

            //Конец инпута
            let send = createButton("")
            ButtonStyling(send)

            send.size(40, 34)
            send.style('border-radius', '8px')
            send.style('position', 'fixed');
            send.style('z-index', '1');
            let sendP = createP("📨")

            sendP.size(40, 34)
            sendP.style('pointer-events', 'none')
            sendP.style('font-size', '24px')
            sendP.style('position', 'fixed');
            sendP.style('z-index', '2');
            let fileS = createButton("")
            ButtonStyling(fileS)

            fileS.size(40, 34)
            fileS.style('border-radius', '8px')
            fileS.mousePressed(() => {
                vlog()
            });
            fileS.style('position', 'fixed');
            fileS.style('z-index', '1');
            let fileSP = createP("📎")

            fileSP.size(40, 34)
            fileSP.style('pointer-events', 'none')
            fileSP.style('font-size', '24px')
            fileSP.style('position', 'fixed');
            fileSP.style('z-index', '2');
            inputposititoner()
                //Конец над полевводные кнопки
            function getTextLength(text) {
                return text.length;
            }

            function sent(message) {
                let cant = false
                if (getCookie("nofilt") == 1) {
                    console.log("Фильтр выключен")
                } else {
                    if (filterTextWithBanwords(message) == message) {
                        console.log("Фильтр включен но матов нет")
                    } else {
                        cant = true
                    }
                }
                //console.log(getTextLength(message))
                if (getTextLength(message) > 350) {
                    alert("Длинное сообщение")
                } else if (getTextLength(message) < 2) {
                    alert("Короткое сообщение!")
                } else if (cant) {
                    alert("Нельзя матерится с фильтром матов!")
                } else {
                    if (message != "") {
                        input.value("")
                        history.push({
                            type: 'text',
                            value: message,
                            sender: pp,
                            time: Math.floor(Date.now() / 1000),
                            uid: getRandomFromRange(111111, 999999)
                        });
                        push()
                    }
                }
            }


            send.mousePressed(() => {
                sent(input.value())
                input.value("")
                biggerINPUT()
            });
        }
    </script>
    <!-- start webpushr code -->
    <script>
        function _webpushrScriptReady() {
            console.log(getCookie("ss"))
            webpushr('attributes', {
                "key1": "value",
                'user_id': getCookie("ss")
            });
        }
        (function(w, d, s, id) {
            if (typeof(w.webpushr) !== 'undefined') return;
            w.webpushr = w.webpushr || function() {
                (w.webpushr.q = w.webpushr.q || []).push(arguments)
            };
            var js, fjs = d.getElementsByTagName(s)[0];
            js = d.createElement(s);
            js.id = id;
            js.async = 1;
            js.src = "https://cdn.webpushr.com/app.min.js";
            fjs.parentNode.appendChild(js);
        }(window, document, 'script', 'webpushr-jssdk'));
        webpushr('setup', {
            'key': 'BFLe_7o4MjpBAJQqK9Zue9crqf0lRfNO6uipfd0w9HRPbZzy0QBIxTXezp_XTPdpXV_dvyDr6GjhTVZpvYlxiUc',
            'user_id': getCookie("ss")
        });
    </script>
    <!-- end webpushr code -->
</body>

</html>