<!DOCTYPE html>
<html lang="ru">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
    <meta charset="UTF-8" />
    <title>TheEM - чат</title>
    <!-- Подключаем библиотеку p5.js и расширение p5.dom -->

    <script src="p5.js"></script>
    <script src="cookie.js"></script>

</head>

<body>
    <script>
        let banwords = new Set();
        let ss = getCookie("ss")
        let pp = getCookie("pp");
        let ps = getCookie("ps")
        let globalres = ""
        let history = []
        let objs = []
        let subut
        let container
        let btnCancel
        let btnDelete
        let btnEdit
        let btnText
        let msgs = 1
        let timer1 = 1
        let lastmsg
        let editmenu = 0

        function setup() {


            function getRandomFromRange(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            if (getCookie("captcha") == "yes") {
                alert("Пройдите капчу")
                window.location.href = "captcha.html"
            }
            overlay = createButton("")
            overlay.position(0, 0);
            overlay.size(windowWidth, windowHeight);
            overlay.style('background', 'rgba(0, 0, 0, 0.6)');
            overlay.style('position', 'fixed');
            overlay.style('z-index', '100');
            overlay.style('pointer-events', 'auto');
            overlay.mousePressed(() => {
                console.log("На оверлей тыкать низя!")
            });
            if (getCookie("IsReg") != "1" || getCookie("name") == getCookie("ываываывауцкцуквпыпewwerwr") || getCookie("name") == "undefined") {
                window.location.href = "homepage.html";
            }

            function Crypt(text) {
                return encodeURIComponent(text);
            }

            function Decrypt(text) {
                try {
                    return decodeURIComponent(text);
                } catch (e) {
                    return text;
                }
            }

            function OvlayShow() {
                overlay.style('background', 'rgba(0, 0, 0, 0.6)');
                overlay.style('z-index', '100');
            }

            function OvlayHide() {
                overlay.style('background', '#ffffff');
                overlay.style('z-index', '-100');
                btnCancel.remove()
                btnDelete.remove()
                btnEdit.remove()
                btnText.remove()
            }
            overlay.style('background', '#ffffff');
            overlay.style('z-index', '-100');

            function SoundEffect(filename) {
                const audio = new Audio(filename);
                audio.play();
            }

            function getCharWidth(char, fontSize = '12px', fontFamily = 'Arial') {
                let span = document.createElement('span');
                span.textContent = char;
                span.style.fontSize = fontSize;
                span.style.fontFamily = fontFamily;
                span.style.visibility = 'hidden';
                document.body.appendChild(span);
                let width = span.offsetWidth;
                span.remove();
                return width;
            }

            function getFirstNChars(str, n) {
                return str.substring(0, n);
            }

            function setCookie2(name, value, options) {
                setCookie(name, value, {
                    expires: new Date('2035-12-31T23:59:59Z'),
                    path: '/',
                    secure: true,
                    samesite: 'strict',
                    ...options // если есть свои параметры — они переопределят дефолтные
                });
            }
            setCookie2("cok", "")
            setInterval(() => {
                timer1++
                if (timer1 == 16) {
                    timer1 = 1
                    msgs = 0
                }
                if (msgs > 7) {
                    alert("НЕ ОТПРАВЛЯЙТЕ МНОГО СООБЩЕНИЙ, ИНАЧЕ БУДЕТ СЛОЖНАЯ КАПТЧА")
                }
                if (msgs > 10) {
                    setCookie2("captcha", "yes")
                    window.location.href = "captcha.html"
                }
                console.log(timer1)
                console.log(msgs)

            }, 1000);

            function MenuShow(editnum) {
                if (history[editnum].sender == pp) {
                    try {
                        let uid = history[editnum].uid
                        if (uid != history[editnum].wewretertsfd) {
                            console.log("Меню для моего сообщения")
                            btnText = createButton(history[editnum].value)
                            btnText.position(windowWidth / 10, 50);
                            btnText.size(windowWidth - windowWidth / 10 - windowWidth / 10, 25)
                            btnText.style('position', 'fixed');
                            btnText.style('z-index', '101');
                            btnText.style('border-radius', '8px');


                            btnEdit = createButton('Изменить');
                            btnEdit.position(0, 100);
                            btnEdit.size(windowWidth, 50)
                            btnEdit.style('position', 'fixed');
                            btnEdit.style('z-index', '101');
                            btnEdit.style('background-color', '#3366cc');
                            btnEdit.mousePressed(() => {
                                editmenu = 1
                                let place = prompt("Новое сообщение:")
                                if (place !== "" && place !== null) {
                                    history[editnum].prevvalue = history[editnum].value
                                    history[editnum].value = place + " (изменено)"
                                    history[editnum].time = Math.floor(Date.now() / 1000)
                                    fetch("https://sebain.pythonanywhere.com/changer?filename=chat_" + getCookie("chatid") + "&text=" + JSON.stringify(history[editnum]) + "&uid=" + uid)
                                        .then(response => response.text())
                                        .then(data => {
                                            SoundEffect("push.mp3")
                                            editmenu = 0
                                            render()
                                            OvlayHide()
                                        })
                                        .catch(error => {
                                            editmenu = 0
                                            console.error("Ошибка при получении данных:", error);
                                        });
                                } else {
                                    editmenu = 0
                                }

                            });

                            btnDelete = createButton('Удалить');
                            btnDelete.position(0, 150);
                            btnDelete.size(windowWidth, 50)
                            btnDelete.style('position', 'fixed');
                            btnDelete.style('z-index', '101');
                            btnDelete.style('background-color', '#ff5733');
                            btnDelete.mousePressed(() => {
                                history[editnum].prevsender = history[editnum].sender
                                history[editnum].prevvalue = history[editnum].value
                                history[editnum].sender = "system"
                                history[editnum].value = "Удалённое сообщение"
                                history[editnum].type = "text"
                                fetch("https://sebain.pythonanywhere.com/changer?filename=chat_" + getCookie("chatid") + "&text=" + JSON.stringify(history[editnum]) + "&uid=" + uid)
                                    .then(response => response.text())
                                    .then(data => {
                                        SoundEffect("push.mp3")
                                        render()
                                        OvlayHide()
                                    })
                                    .catch(error => {
                                        console.error("Ошибка при получении данных:", error);
                                    });
                            });

                            btnCancel = createButton('Отмена');
                            btnCancel.position(0, 200);
                            btnCancel.size(windowWidth, 50)
                            btnCancel.style('position', 'fixed');
                            btnCancel.style('z-index', '101');
                            btnCancel.style('background-color', '#b3b3b3');
                            btnCancel.mousePressed(() => {
                                OvlayHide()
                            });
                        } else {
                            OvlayHide()
                        }
                    } catch {
                        console.log("Нету uid!")
                    }

                } else if (history[editnum].sender == "system") {
                    console.log("Системное сообщение : меню не доступно")
                    OvlayHide()
                } else {
                    console.log("Чужое сообщение, пока не доступно")
                    OvlayHide()
                }
            }

            function render() {
                //setCookie2(getCookie("chatid") + "_history", JSON.stringify(history))
                let schatix = history[history.length - 1]
                fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_oldchat" + getCookie("chatid") + "&text=" + Crypt(JSON.stringify(schatix)))
                    .then(response => response.text())
                    .then(data => {
                        globalres = data;
                        console.log(globalres); // выводим уже присвоенное значение
                    })
                    .catch(error => {
                        console.error("Ошибка при получении данных:", error);
                    });
                let superbutton = createButton("А что вы тут забыли????")
                superbutton.position(0, 1000000)
                container.child(superbutton)
                let autor
                let num = objs.length - 1
                while (num > -1) {
                    try {
                        objs[num].remove()
                    } catch {
                        console.log("НЕ УДАЛЕНО!")
                    }
                    num--
                }
                num = history.length - 1
                while (num > -1) {
                    if (history[num].type == "text") {
                        let colour
                        if (history[num].sender == pp) {
                            autor = "Вы:\n"
                            colour = "#66ff66"
                        } else if (history[num].sender == "system") {
                            autor = "Система:\n"
                            colour = "#669999"
                        } else {
                            autor = getCookie("name") + ":\n"
                            colour = "#6699ff"
                        }
                        let unixTime = history[num].time // Пример Unix-времени
                        let date = new Date(unixTime * 1000); // Преобразуем в миллисекунды

                        // Форматируем вручную
                        let options = {
                            hour: '2-digit',
                            minute: '2-digit',
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric',
                            timeZone: 'Europe/Minsk',
                        };

                        let time = date.toLocaleString('ru-RU', options);
                        console.log(time); // "11:00 30 июля 2025 г."
                        let text = history[num].value
                        if (getCookie("nofilt") != 1) {
                            text = filterTextWithBanwords(text);
                        }
                        objs[num] = createButton(time + "\n" + autor + text)
                        objs[num].style('white-space', 'pre-wrap');
                        objs[num].style('text-align', 'left');
                        objs[num].style('background-color', colour); // фон кнопки
                        objs[num].style('border-radius', '12px');

                        container.child(objs[num]);
                        let mynum = num
                        objs[num].mousePressed(() => {
                            OvlayShow()
                            MenuShow(mynum)
                            console.log(mynum)
                        });
                    }

                    num--
                }
                superbutton.remove()
            }



            function update() {
                if (editmenu == 0) {
                    console.log("Обновление")
                    fetch("https://sebain.pythonanywhere.com/get?filename=chat_" + getCookie("chatid"))
                        .then(response => response.text())
                        .then(data2 => {
                            data2 = Decrypt(data2)
                            let data = JSON.stringify(JSON.parse(data2))
                            console.log(data)
                            console.log(JSON.stringify(history))
                            if (data == JSON.stringify(history)) {
                                console.log("Новых сообщений нет")
                            } else {
                                SoundEffect("msg.mp3")
                                history = JSON.parse(data)
                                render()
                            }


                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                        });
                }
            }

            function push() {
                if (lastmsg == history[history.length - 1].value) {
                    history.splice(history.length - 1, 1);
                } else {
                    lastmsg = history[history.length - 1].value;
                    msgs++;
                    SoundEffect("push.mp3");
                    historyP = history[history.length - 1];
                    let pushing = JSON.stringify(historyP);
                    console.log(pushing);
                    fetch("https://sebain.pythonanywhere.com/push?filename=chat_" + getCookie("chatid") + "&text=" + Crypt(pushing))
                        .then(response => response.text())
                        .then(data => {
                            console.log("Загрузка " + data);
                            render();
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                        });
                }
            }

            function pushAll() {
                msgs++;
                SoundEffect("push.mp3");

                let pushing = JSON.stringify(history);
                let payload = {
                    filename: "chat_" + getCookie("chatid"),
                    text: pushing
                };

                fetch("https://sebain.pythonanywhere.com/set_post", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.text())
                    .then(data => {
                        console.log("Загрузка " + data);
                        render();
                    })
                    .catch(error => {
                        console.error("Ошибка при получении данных:", error);
                    });
            }


            window.addEventListener("resize", () => {
                ban.position(window.innerWidth - 80, 0)
                send.position(window.innerWidth - 90, window.innerHeight - 30)
                input.position(0, window.innerHeight - 30)
                input.size(window.innerWidth - 100, 20)
                container.size(window.innerWidth - 75, window.innerHeight - 100)
                container.position(0, 25)
                overlay.size(windowWidth, windowHeight);
                try {
                    btnText.position(windowWidth / 10, 50);
                    btnText.size(windowWidth - windowWidth / 10 - windowWidth / 10, 25)
                    btnEdit.size(windowWidth, 50)
                    btnDelete.size(windowWidth, 50)
                    btnCancel.size(windowWidth, 50)
                } catch {
                    console.log("Не нашёл я оверлей")
                }

            });
            noCanvas(); // отключаем холст, если он не нужен
            function filterTextWithBanwords(inputText) {
                if (banwords.size === 0) {
                    console.warn('Список banwords ещё не загружен');
                    return inputText;
                }

                // Разбиваем на слова, пробелы и знаки препинания
                const tokens = inputText.match(/[\wа-яА-ЯёЁ]+|[^\w\s]|[\s]+/g);

                const filtered = tokens.map(token => {
                    const normalized = token.toLowerCase().replace(/[^а-яa-z0-9]/gi, '');
                    return banwords.has(normalized) ? '(мат)' : token;
                });

                return filtered.join('');
            }


            function bantest() {
                const rawText = "Ты чё, гандон, совсем?";
                const cleanText = filterTextWithBanwords(rawText);
                console.log(cleanText); // "Ты чё, (мат), совсем?"
            }


            // Загружаем banwords.txt при старте
            fetch('/banword.txt')
                .then(res => res.text())
                .then(text => {
                    text
                        .split(/\r?\n/)
                        .map(w => w.trim().toLowerCase())
                        .forEach(w => {
                            if (w.length > 0) banwords.add(w);
                        });
                    console.log(`Загружено ${banwords.size} запрещённых слов`);
                    bantest()
                    update()

                });

            function reloadOnline() {
                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + getCookie("target") + "_last-online&text=" + Math.floor(Date.now() / 1000))
                    .then(response => response.text())
                    .then(data => {
                        let dif1 = Math.floor(Date.now() / 1000) - data
                        let dstate
                        if (dif1 < 60) {
                            dstate = "В сети";
                        } else if (dif1 < 60 * 2) {
                            dstate = "В сети минуту назад";
                        } else if (dif1 < 60 * 60) {
                            dstate = "В сети " + Math.floor(dif1 / 60) + " минут назад";
                        } else if (dif1 < 60 * 60 * 24) {
                            dstate = "В сети " + Math.floor(dif1 / 60 / 60) + " часов назад";
                        } else {
                            dstate = "В сети " + Math.floor(dif1 / 60 / 60 / 24) + " дней назад";
                        }
                        name.html(getCookie("name") + " (" + dstate + ")")
                    })
                    .catch(error => {
                        name.html(getCookie("name"))
                    });
            }
            let found = 0
            setInterval(() => {
                fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_last-online&text=" + Math.floor(Date.now() / 1000))
                    .then(response => response.text())
                    .then(data => {

                    })
                    .catch(error => {

                    });
                reloadOnline()
                console.log("Каждые 5 секунд: пип!");
                update()
                let num = history.length - 1
                if (found == 0) {
                    while (num > -1) {
                        if (history[num].sender == pp) {
                            num = -1000
                            found = 1
                        }
                        num--
                    }
                    if (found == 0) {
                        let placeholder = [{
                            type: 'invis',
                            value: "placeholder for notifications",
                            sender: pp,
                            time: Math.floor(Date.now() / 1000)
                        }];
                        let backpush = JSON.stringify(placeholder)
                        fetch("https://sebain.pythonanywhere.com/backpush?filename=chat_" + getCookie("chatid") + "&text=" + backpush)
                            .then(response => response.text())
                            .then(data => {
                                update()
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    }
                }
            }, 5000)
            console.log(getCharWidth('Aкваматика 2'));
            console.log(getFirstNChars('Aкваматика 2', 4)) // 10 считать как за отступ
            container = createDiv();
            container.id("chat-container"); // дадим ID для удобства
            container.style('display', 'flex');
            container.style('flex-direction', 'column');
            container.style('gap', '10px');
            container.style('padding', '20px');
            container.style('overflow', 'auto');
            container.size(window.innerWidth - 75, window.innerHeight - 100)
            container.position(0, 25)
            let exit = createButton("Выход")
            exit.mousePressed(() => {
                window.location.href = "homepage.html"

            });
            exit.position(0, 0)
            let name = createP(getCookie("name"))
            name.style('background-color', getCookie("colour"));
            name.position(55, -15)
            reloadOnline()
            let ban = createButton("Удалить!")
            ban.mousePressed(() => {
                let confirm = prompt(
                    "Если вы и вправду хотите удалить чат с: " + getCookie("name") +
                    ", то просто введи это число: " + getCookie("chatid") + " и нажми ок"
                );

                if (confirm === getCookie("chatid")) {
                    fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_chats")
                        .then(response => response.text())
                        .then(data => {
                            let list = JSON.parse(data);

                            // отфильтруем весь массив сразу, убрав чат с нужным chatid
                            const newList = list.filter(obj => obj.chatid !== getCookie("chatid"));

                            const exportJson = JSON.stringify(newList);

                            return fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_chats" + "&text=" + exportJson);
                        })
                        .then(response => response.text())
                        .then(() => {

                            history.push({
                                type: 'text',
                                value: "Собеседник удалил переписку, слать сюда чтото бесполезно!",
                                sender: "system",
                                time: Math.floor(Date.now() / 1000)
                            });

                            SoundEffect("push.mp3");

                            let pushing = JSON.stringify(history);
                            let payload = {
                                filename: "chat_" + getCookie("chatid"),
                                text: pushing
                            };

                            fetch("https://sebain.pythonanywhere.com/set_post", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify(payload)
                                })
                                .then(response => response.text())
                                .then(data => {
                                    console.log("Загрузка" + data);
                                    render();
                                    fetch("https://sebain.pythonanywhere.com/unreg?filename=chat_" + getCookie("chatid") + "&key=" + ps)
                                        .then(response => response.text())
                                        .then(data => {
                                            render()
                                            alert("Удалено!");
                                            window.location.href = "homepage.html";
                                        })
                                        .catch(error => {
                                            console.error("Ошибка при получении данных:", error);
                                        });

                                })
                                .catch(error => {
                                    console.error("Ошибка при получении данных:", error);
                                });

                        })
                        .catch(error => {
                            console.error("Ошибка при удалении:", error);
                        });
                }
            })
            ban.position(window.innerWidth - 80, 0)
            let input = createInput()
            input.attribute('placeholder', 'Введите текст...');
            input.style('font-size', '12px');
            input.position(0, window.innerHeight - 30)
            input.size(window.innerWidth - 100, 20)
            let send = createButton("Слать")
            send.position(window.innerWidth - 90, window.innerHeight - 30)
            send.size(75, 25)

            function getTextLength(text) {
                return text.length;
            }

            function sent(message) {
                let cant = false
                if (getCookie("nofilt") == 1) {
                    console.log("Фильтр выключен")
                } else {
                    if (filterTextWithBanwords(message) == message) {
                        console.log("Фильтр включен но матов нет")
                    } else {
                        cant = true
                    }
                }
                //console.log(getTextLength(message))
                if (getTextLength(message) > 350) {
                    alert("Длинное сообщение")
                } else if (getTextLength(message) < 4) {
                    alert("Короткое сообщение!")
                } else if (cant) {
                    alert("Нельзя матерится с фильтром матов!")
                } else {
                    if (message != "") {
                        input.value("")
                        history.push({
                            type: 'text',
                            value: message,
                            sender: pp,
                            time: Math.floor(Date.now() / 1000),
                            uid: getRandomFromRange(111111, 999999)
                        });
                        push()
                    }
                }
            }
            input.elt.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    console.log('Enter нажат: ' + input.value());
                    sent(input.value())

                }
            });
            send.mousePressed(() => {
                sent(input.value())
            });
        }
    </script>
</body>

</html>