<!DOCTYPE html>
<html lang="ru">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
    <meta charset="UTF-8" />
    <title>TheEM - Список чатов</title>
    <!-- Подключаем библиотеку p5.js и расширение p5.dom -->

    <script src="p5.js"></script>
    <script src="cookie.js"></script>
</head>

<body>
    <script>
        let myButton;
        let ss = getCookie("ss")
        let pp = getCookie("pp");
        let ps = getCookie("ps")
        let globalres = ""
        let chatbuttons = []

        function setup() {
            setCookie2("chatid", "undefined")
            setCookie2("name", "undefined")
            if (getCookie("IsReg") != "1") {
                window.location.href = "index.html";
            }

            function Crypt(text) {
                return encodeURIComponent(text);
            }

            function Decrypt(text) {
                try {
                    return decodeURIComponent(text);
                } catch (e) {
                    return text;
                }
            }

            function setCookie2(name, value, options) {
                setCookie(name, value, {
                    expires: new Date('2035-12-31T23:59:59Z'),
                    path: '/',
                    secure: true,
                    samesite: 'strict',
                    ...options // если есть свои параметры — они переопределят дефолтные
                });
            }


            function addchat(newchats) {
                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_chats")
                    .then(response => response.text())
                    .then(data => {
                        globalres = data
                        console.log(globalres)
                        let chats = JSON.parse(globalres)
                        let num = newchats.length - 1
                        while (num > -1) {
                            chats.push({
                                target: newchats[num].target,
                                chatid: newchats[num].chatid
                            });
                            num--
                        }
                        let exportJson = JSON.stringify(chats)
                        console.log(exportJson)
                        fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_chats" + "&text=" + exportJson)
                            .then(response => response.text())
                            .then(data => {
                                globalres = data; // вызываем только после получения данных
                                console.log(globalres); // выводим уже присвоенное значение
                                window.location.href = "homepage.html";
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    })
                    .catch(error => {
                        console.error("Ошибка при получении данных:", error);
                        let chats = []
                        let num = newchats.length - 1
                        while (num > -1) {
                            chats.push({
                                target: newchats[num].target,
                                chatid: newchats[num].chatid
                            });
                            num--
                        }
                        let exportJson = JSON.stringify(chats)
                        fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_chats" + "&text=" + exportJson)
                            .then(response => response.text())
                            .then(data => {
                                globalres = data; // вызываем только после получения данных
                                console.log(globalres); // выводим уже присвоенное значение
                                window.location.href = "homepage.html";
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    });
            }
            // Загружаем новые чаты
            fetch("https://sebain.pythonanywhere.com/get?filename=newchats_" + pp)
                .then(response => response.text())
                .then(data => {
                    globalres = data; // вызываем только после получения данных
                    console.log(globalres); // выводим уже присвоенное значение
                    try {
                        let newchats = JSON.parse(globalres)
                        addchat(newchats)
                        fetch("https://sebain.pythonanywhere.com/set?filename=newchats_" + pp + "&text=voidblank1")
                            .then(response => response.text())
                            .then(data => {
                                globalres = data; // вызываем только после получения данных
                                console.log(globalres); // выводим уже присвоенное значение
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    } catch {
                        console.log("Если это не джсон то там ничё нет")
                    }
                })
                .catch(error => {
                    console.error("Собственно если файла с чатами нет то зачем нам чтото делать ", error);
                });
            //Инитиализация
            function getRandomBrightColor() {
                const brightColors = [
                    'FF5733', 'FF8C00', 'FFD700', 'ADFF2F', '00FF7F', '00FFFF', '1E90FF', '4169E1',
                    '9932CC', 'FF69B4', 'FF1493', 'FF4500', '32CD32', '00CED1', 'DC143C', '8A2BE2',
                    'FF6347', 'FFA07A', 'FF7F50', 'FFB6C1', 'FA8072', 'F08080', 'F0E68C', 'EEE8AA',
                    'DAA520', 'B8860B', 'D2691E', 'CD5C5C', '8B0000', 'A52A2A', 'B22222', 'BC8F8F',
                    'FF00FF', '8B008B', '9400D3', 'BA55D3', '9370DB', '7B68EE', '6A5ACD', '483D8B',
                    '6495ED', '40E0D0', '48D1CC', '00BFFF', '87CEFA', '87CEEB', '4682B4', '5F9EA0',
                    '00FA9A', '00FF00', '7FFF00', '7CFC00', '32CD32', '98FB98', '90EE90', '8FBC8F',
                    '3CB371', '2E8B57', '228B22', '006400', '66CDAA', '20B2AA', '008B8B', '008080',
                    'B0E0E6', 'AFEEEE', 'ADD8E6', 'B0C4DE', '778899', '708090', 'BEBEBE', 'D3D3D3',
                    'C0C0C0', 'A9A9A9', '808080', '696969', '2F4F4F', '000000', 'FFFFFF', 'F5F5F5',
                    'FFE4B5', 'FFEBCD', 'FFF0F5', 'FFFACD', 'FAFAD2', 'FFEFD5', 'FFDAB9', 'E6E6FA',
                    'D8BFD8', 'DDA0DD', 'EE82EE', 'DA70D6', 'FF00FF', 'C71585', 'DB7093', 'FF1493',
                    'FF69B4', 'FFC0CB', 'FFA07A', 'FF7F50', 'FF6347', 'FF4500', 'FF8C00', 'FFA500',
                    'FFD700', 'FFFF00', 'FFFFE0', 'F0E68C', 'EEDD82', 'DAA520', 'BDB76B', 'B8860B'
                ];
                const randomIndex = Math.floor(Math.random() * brightColors.length);
                return brightColors[randomIndex];
            }


            function getRandomFromRange(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            window.addEventListener("resize", () => {
                idtext.position(0, window.innerHeight - 35)
                addbutton.position(window.innerWidth - 150, window.innerHeight - 75)
                changebutton.position(window.innerWidth - 100, 25)
                colour.position(window.innerWidth - 200, 25)
                let num = chatbuttons.length - 1
                while (num > -1) {
                    let tbutton = chatbuttons[num]
                    tbutton.size(window.innerWidth, 35)
                    num--

                }
            });
            noCanvas()
                //Загрузка чатов
            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_chats")
                .then(response => response.text())
                .then(data => {
                    chatsJSON = data;
                    console.log(chatsJSON) // выводим уже присвоенное значение
                    let tchats = JSON.parse(chatsJSON)
                    let num = tchats.length - 1
                    let btnum = 0
                    let pos = 75
                    while (num > -1) {
                        let xpos = pos
                        let xbtnum = btnum
                        let xnum = num

                        fetch("https://sebain.pythonanywhere.com/saveget?filename=" + tchats[xnum].target + "_profn")
                            .then(response => response.text())
                            .then(data => {
                                let clr
                                let xid = tchats[xnum].chatid
                                let tbutton = createButton(data)
                                let xdata = data
                                tbutton.style('white-space', 'pre-wrap');
                                //tbutton.html("Текст")
                                tbutton.position(0, xpos)
                                tbutton.size(window.innerWidth, 35)
                                tbutton.style('border-radius', '8px');
                                tbutton.style('text-align', 'left');
                                tbutton.style('padding-left', '12px');
                                chatbuttons[xbtnum] = tbutton
                                tbutton.mousePressed(() => {
                                    setCookie2("chatid", xid)
                                    setCookie2("name", data)
                                    setCookie2("colour", clr)
                                    window.location.href = "chat.html";
                                });
                                fetch("https://sebain.pythonanywhere.com/get?filename=chat_" + xid)
                                    .then(response => response.text())
                                    .then(data => {
                                        let history_newJSON = data
                                        fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_oldchat" + xid)
                                            .then(response => response.text())
                                            .then(data => {
                                                data = Decrypt(data)
                                                let history_oldJSON = data
                                                if (history_newJSON == history_oldJSON) {
                                                    let history = JSON.parse(history_newJSON)
                                                    let l = history.length - 1
                                                    tbutton.html(xdata + " [ПОСЛЕДНЕЕ]\n" + history[l].value)

                                                } else {
                                                    tbutton.html(xdata + " [НОВОЕ]")
                                                }
                                            })
                                            .catch(error => {
                                                console.error("Ошибка при получении данных:", error);
                                            });

                                    })
                                    .catch(error => {
                                        console.error("Ошибка при получении данных:", error);
                                    });
                                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + tchats[xnum].target + "_colour")
                                    .then(response => response.text())
                                    .then(data => {
                                        console.log(data)
                                        if (data == "Файл не найден в save") {
                                            console.log("Не получен цвет" + tchats[xnum].target)
                                        } else {
                                            tbutton.style('background-color', "#" + data);
                                            clr = "#" + data
                                        }
                                    })
                                    .catch(error => {
                                        console.error(error)
                                    });
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                        pos = pos + 35
                        btnum++
                        num--
                    }
                })
                .catch(error => {
                    console.error("Ошибка при получении данных:", error);
                    alert("У вас нет ни одного чата??? Так добавь своего друга по его ID, если уже добавил или хочешь добавить жми ОК")
                });
            //Ник
            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_profn")
                .then(response => response.text())
                .then(data => {
                    createP(data)
                })
                .catch(error => {
                    console.error("Ошибка при получении данных:", error);
                    alert("Ошибка получения ника! Видно нет интернета!!!")
                });
            console.log(getRandomBrightColor())
            let colour = createButton("Цвет ника⚙");
            colour.position(window.innerWidth - 200, 25)
            colour.style('border-radius', '12px');
            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_colour")
                .then(response => response.text())
                .then(data => {
                    console.log(data)
                    if (data == "Файл не найден в save") {
                        crush
                    }
                    colour.style('background-color', "#" + data);
                })
                .catch(error => {
                    fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_colour&text=" + getRandomBrightColor())
                        .then(response => response.text())
                        .then(data => {
                            globalres = data; // вызываем только после получения данных
                            console.log(globalres);
                            window.location.href = "homepage.html"; // выводим уже присвоенное значение
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                            alert("Проверьте интернет!!! Он возможно ламатый у вас!")
                        });
                });
            colour.mousePressed(() => {
                fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_colour&text=" + getRandomBrightColor())
                    .then(response => response.text())
                    .then(data => {
                        globalres = data; // вызываем только после получения данных
                        console.log(globalres);
                        window.location.href = "homepage.html"; // выводим уже присвоенное значение
                    })
                    .catch(error => {
                        console.error("Ошибка при получении данных:", error);
                        alert("Проверьте интернет!!! Он возможно ламатый у вас!")
                    });
            });
            let changebutton = createButton("Ник⚙");
            changebutton.position(window.innerWidth - 100, 25)
            changebutton.style('border-radius', '12px');
            changebutton.mousePressed(() => {
                let newnik = prompt("Введите новое имя/ник/заголовок (Используйте только буковки, циферки, @ и . )(Другие симолы нельзя)")
                if (newnik == "") {
                    alert("Ник не может быть пустым!!")
                } else {
                    fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_profn&text=" + newnik)
                        .then(response => response.text())
                        .then(data => {
                            globalres = data; // вызываем только после получения данных
                            console.log(globalres);
                            window.location.href = "homepage.html"; // выводим уже присвоенное значение
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                        });
                }
            });
            // Остальное 
            let idtext = createP("Ваш id:" + pp)
            idtext.position(0, window.innerHeight - 35)
            let addbutton = createButton("Добавить по ID")
            addbutton.style('background-color', '#339933'); // фон кнопки
            addbutton.style('border-radius', '12px');
            addbutton.position(window.innerWidth - 150, window.innerHeight - 75)
            addbutton.mousePressed(() => {
                let globalres = ""
                let addid = prompt("Введите id вашего собеседника")
                if (addid != pp || addid != "" || addid != "1") {
                    fetch("https://sebain.pythonanywhere.com/saveget?filename=" + addid + "_profn")
                        .then(response => response.text())
                        .then(data => { // вызываем только после получения данных

                            console.log(data);
                            if (data == "Файл не найден в save") {
                                alert("НЕВЕРНЫЙ ID")
                                window.href.location = "homepage.html"
                            }
                            let chatid = String(getRandomFromRange(11111, 99999))

                            function sent(chats, addid, chatid, pp) {
                                chats.push({
                                    target: pp,
                                    chatid: chatid
                                });

                                let targetJSON = JSON.stringify(chats)
                                let our = [{
                                    target: addid,
                                    chatid: chatid
                                }];
                                let ourJSON = JSON.stringify(our)
                                let placeholder = [{
                                    type: 'text',
                                    value: "Привет",
                                    sender: pp,
                                    time: 0
                                }];
                                let placeholderJSON = JSON.stringify(placeholder)
                                fetch("https://sebain.pythonanywhere.com/set?filename=chat_" + chatid + "&text=" + placeholderJSON)
                                    .then(response => response.text())
                                    .then(data => {
                                        data = data
                                        fetch("https://sebain.pythonanywhere.com/set?filename=newchats_" + addid + "&text=" + targetJSON)
                                            .then(response => response.text())
                                            .then(data => {
                                                globalres = data;
                                                fetch("https://sebain.pythonanywhere.com/set?filename=newchats_" + pp + "&text=" + ourJSON)
                                                    .then(response => response.text())
                                                    .then(data => {
                                                        globalres = data; // выводим уже присвоенное значение
                                                        alert("Чат добавлен, успех!")
                                                        window.location.href = "homepage.html"
                                                    })
                                                    .catch(error => {
                                                        alert("АЛЁЁЁЁ, ВСЁ СЛАМАЛАСЯ")
                                                    }); // выводим уже присвоенное значение
                                            })
                                            .catch(error => {
                                                alert("АЛЁЁЁЁ, ВСЁ СЛАМАЛАСЯ")
                                            });
                                    })
                                    .catch(error => {
                                        alert("АЛЁЁЁЁ, ВСЁ СЛАМАЛАСЯ")
                                    });
                            }
                            fetch("https://sebain.pythonanywhere.com/get?filename=newchats_" + addid)
                                .then(response => response.text())
                                .then(data => {
                                    globalres = data;
                                    try {
                                        let chats = JSON.parse(globalres)
                                        sent(chats, addid, chatid, pp)
                                    } catch {
                                        console.log(error);
                                        let chats = []
                                        sent(chats, addid, chatid, pp)

                                    } // выводим уже присвоенное значение
                                })
                                .catch(error => {
                                    console.log(error)
                                    let chats = []
                                    sent(chats, addid, chatid, pp)
                                }); // выводим уже присвоенное значение
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                            alert("Не верный ID")
                            window.location.href = "homepage.html";
                        });
                } else {
                    alert("Не верный Id")
                }





            });
        }
    </script>
</body>

</html>