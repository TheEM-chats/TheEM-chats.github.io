<!DOCTYPE html>
<html lang="ru">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<style>
    html,
    body {
        overflow: hidden;
        margin: 0;
        padding: 0;
    }
</style>

<head>
    <meta charset="UTF-8" />
    <title>TheEM - Главная страница</title>
    <!-- Подключаем библиотеку p5.js и расширение p5.dom -->

    <script src="libs/p5.js"></script>
    <script src="libs/xlibs.js"></script>
</head>

<body>
    <script>
        var state = 1
        var last_state = state
        var anim = "n"
        var btn
        var x = 0

        let setts_frame
        let chatlist_frame
        let addbyid_frame
        if (getCookie("IsReg") != "1") {
            window.location.href = "index.html";
        }

        function hide(element) {
            element.style('visibility', 'hidden')
        }

        function show(element) {
            element.style('visibility', 'visible');
        }

        function hideall() {
            hide(setts_frame)
            hide(chatlist_frame)
            hide(addbyid_frame)
        }

        function start() {
            reload = createButton("↻")
            ButtonStyling(reload)
            reload.size(25, 25)
            reload.position(window.innerWidth - 25 - 5, 5)
            reload.style('position', 'fixed');
            reload.style('z-index', '100');
            reload.mousePressed(() => {
                chatlist_frame.elt.contentWindow.location.reload()
                addbyid_frame.elt.contentWindow.location.reload()
                setts_frame.elt.contentWindow.location.reload()
            });

            chatlist = createButton("Мои чаты")
            chatlist.style('color', '#ffffff');
            chatlist.style('background', 'transparent');
            chatlist.size(window.innerWidth / 3, 35)
            chatlist.position(0, window.innerHeight - 35)
            chatlist.style('border-radius', '5px')
            chatlist.style('border', '2px solid #bbbbbb');
            chatlist.mousePressed(() => {
                x = 0
                state = 1
            });
            addbyid = createButton("Добавить по id")
            addbyid.style('color', '#ffffff');
            addbyid.style('background', 'transparent');
            addbyid.size(window.innerWidth / 3, 35)
            addbyid.position(window.innerWidth / 3, window.innerHeight - 35)
            addbyid.style('border-radius', '5px')
            addbyid.style('border', '2px solid #bbbbbb');
            addbyid.mousePressed(() => {
                x = window.innerWidth / 3
                state = 2
            });
            setts = createButton("Другое")
            setts.style('color', '#ffffff');
            setts.style('background', 'transparent');
            setts.size(window.innerWidth / 3, 35)
            setts.position(window.innerWidth / 3 * 2, window.innerHeight - 35)
            setts.style('border-radius', '5px')
            setts.style('border', '2px solid #bbbbbb');
            setts.mousePressed(() => {
                x = window.innerWidth / 3 * 2
                state = 3
            });
            btn = createButton('')
            ButtonStyling(btn)
            btn.size(window.innerWidth / 3, 35)
            btn.style('border-radius', '8px')
            btn.style('z-index', '-1')
            btn.style('position', 'absolute')
            btn.style('background', 'rgba(0, 5, 150, 0.6)')
            btn.style('box-shadow', '0 2px 6px rgba(0, 5, 150, 0.8)')
            btn.mouseOver(() => {});
            btn.mouseOut(() => {});
            btn.style('cursor', 'default')

        }

        function setup() {
            noCanvas(); // отключаем холст, если он не нужен
            BackStyling()
                //start()
            setts_frame = createElement('iframe');
            setts_frame.attribute('src', 'setts.html');
            setts_frame.size(window.innerWidth - 3, window.innerHeight - 35 - 3);
            setts_frame.position(0, 0);

            chatlist_frame = createElement('iframe');
            chatlist_frame.attribute('src', 'chatlist.html');
            chatlist_frame.size(window.innerWidth - 3, window.innerHeight - 35 - 3);
            chatlist_frame.position(0, 0);

            addbyid_frame = createElement('iframe');
            addbyid_frame.attribute('src', 'addbyid.html');
            addbyid_frame.size(window.innerWidth - 3, window.innerHeight - 35 - 3);
            addbyid_frame.position(0, 0);
            hideall()

            //Начальное меню
            InProcess++
            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + getCookie("pp") + "_profn")
                .then(response => response.text())
                .then(data => {
                    InProcess--
                    let hibutton = createButton("Привет," + data + "\n рады видеть вас тут!")
                    hibutton.style('white-space', 'pre-wrap');
                    ButtonStyling(hibutton)
                    let get = createButton("<К моим чатам>")
                    get.size(200, 25)
                    get.position((window.innerWidth - 200) / 2, window.innerHeight / 3 * 2 - 75)
                    ButtonStyling(get)
                    get.style('background', 'rgba(100, 200, 150, 0.18)');
                    get.style('box-shadow', '0 2px 6px rgba(0, 100, 50, 0.15)');

                    get.mouseOver(() => {
                        get.style('background', 'rgba(120, 220, 170, 0.25)');
                        get.style('box-shadow', '0 3px 10px rgba(0, 100, 50, 0.25)');
                    });

                    get.mouseOut(() => {
                        get.style('background', 'rgba(100, 200, 150, 0.18)');
                        get.style('box-shadow', '0 2px 6px rgba(0, 100, 50, 0.15)');
                    });
                    get.mousePressed(() => {
                        get.remove()
                        hibutton.remove()
                        fsimgX.remove()
                        start()
                        show(chatlist_frame)
                    });
                    let fsimgX = createButton('');
                    fsimgX.style('z-index', '101');
                    fsimgX.size(128, 128)
                    fsimgX.position((window.innerWidth - 128) / 2, window.innerHeight / 3 - window.innerHeight / 9)
                    ButtonStyling(fsimgX)
                    fsimgX.style('background-image', 'url("ico2.jpg")')
                    fsimgX.style('background-size', 'cover');
                    fsimgX.style('border-radius', '15px')
                    fsimgX.mouseOver(() => {});
                    fsimgX.mouseOut(() => {});
                    BackStyling()
                })
                .catch(error => {
                    InProcess--
                });
            setInterval(() => {
                console.log("Обновление")
                btn.position(x, window.innerHeight - 35 - 3)
                let currentURL = chatlist_frame.elt.contentWindow.location.href;
                if (currentURL != "http://localhost:8000/chatlist.html" && currentURL != "https://theem-chats.github.io/chatlist.html") {
                    window.location.href = "chat.html"
                }
                if (last_state != state) {
                    last_state = state
                    hideall()
                    if (state == 1) {
                        show(chatlist_frame)
                    } else if (state == 2) {
                        show(addbyid_frame)
                        chatlist_frame.elt.contentWindow.location.reload();
                    } else if (state == 3) {
                        show(setts_frame)
                        chatlist_frame.elt.contentWindow.location.reload();
                    }
                }
            }, 200);

        }
    </script>
    <!-- start webpushr code -->
    <script>
        function _webpushrScriptReady() {
            console.log(getCookie("ss"))
            webpushr('attributes', {
                "key1": "value",
                'user_id': getCookie("ss")
            });
        }
        (function(w, d, s, id) {
            if (typeof(w.webpushr) !== 'undefined') return;
            w.webpushr = w.webpushr || function() {
                (w.webpushr.q = w.webpushr.q || []).push(arguments)
            };
            var js, fjs = d.getElementsByTagName(s)[0];
            js = d.createElement(s);
            js.id = id;
            js.async = 1;
            js.src = "https://cdn.webpushr.com/app.min.js";
            fjs.parentNode.appendChild(js);
        }(window, document, 'script', 'webpushr-jssdk'));
        webpushr('setup', {
            'key': 'BFLe_7o4MjpBAJQqK9Zue9crqf0lRfNO6uipfd0w9HRPbZzy0QBIxTXezp_XTPdpXV_dvyDr6GjhTVZpvYlxiUc',
            'user_id': getCookie("ss")
        });
    </script>
    <!-- end webpushr code -->
    <script>
        if (typeof navigator.serviceWorker !== 'undefined') {
            navigator.serviceWorker.register('webpushr-sw.js')
        }
    </script>
</body>

</html>