<!DOCTYPE html>
<html lang="ru">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/favicon.png" type="image/png">

<head>
    <meta charset="UTF-8" />
    <title>TheEM - Список чатов</title>
    <!-- Подключаем библиотеку p5.js и расширение p5.dom -->

    <script src="p5.js"></script>
    <script src="cookie.js"></script>
</head>

<body>
    <script>
        let myButton;
        let ss = getCookie("ss")
        let pp = getCookie("pp");
        let ps = getCookie("ps")
        let globalres = ""
        let chatbuttons = []
        let chatimgs = []

        function setup() {
            overlay = createButton("")
            overlay.position(0, 0);
            overlay.size(windowWidth, windowHeight);
            overlay.style('background', 'rgba(0, 0, 0, 0.6)');
            overlay.style('position', 'fixed');
            overlay.style('z-index', '100');
            overlay.style('pointer-events', 'auto');
            overlay.mousePressed(() => {
                console.log("На оверлей тыкать низя!")
            });
            overlay.style('background', '#ffffff');
            overlay.style('z-index', '-100');

            function getProfUrl(pubk, element) {
                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pubk + "_img")
                    .then(response => response.text())
                    .then(data => {
                        data = Decrypt(data)
                        console.log(data)
                        if (data == "Файл не найден в save") {
                            element.style('background-image', 'url("https://i.ibb.co/F4qyF7RN/blank.png")')
                        } else {
                            element.style('background-image', `url("${data}")`);

                        }
                    })
                    .catch(error => {
                        element.style('background-image', 'url("https://i.ibb.co/F4qyF7RN/blank.png")')
                    });
            }
            //            let picker
            //            picker = createColorPicker('#ff0000'); // начальный цвет — красный
            //            picker.position(10, 220);
            setCookie2("chatid", "undefined")
            setCookie2("name", "undefined")
            if (getCookie("captcha") == "yes") {
                alert("Пройдите капчу")
                window.location.href = "captcha.html"
            }
            if (getCookie("IsReg") != "1") {
                window.location.href = "index.html";
            }

            function Crypt(text) {
                return encodeURIComponent(text);
            }

            function Decrypt(text) {
                try {
                    return decodeURIComponent(text);
                } catch (e) {
                    return text;
                }
            }

            function setCookie2(name, value, options) {
                setCookie(name, value, {
                    expires: new Date('2035-12-31T23:59:59Z'),
                    path: '/',
                    secure: true,
                    samesite: 'strict',
                    ...options // если есть свои параметры — они переопределят дефолтные
                });
            }


            function addchat(newchats) {
                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_chats")
                    .then(response => response.text())
                    .then(data => {
                        globalres = data
                        console.log(globalres)
                        let chats = JSON.parse(globalres)
                        let num = newchats.length - 1
                        while (num > -1) {
                            chats.push({
                                target: newchats[num].target,
                                chatid: newchats[num].chatid
                            });
                            num--
                        }
                        let exportJson = JSON.stringify(chats)
                        console.log(exportJson)
                        fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_chats" + "&text=" + exportJson)
                            .then(response => response.text())
                            .then(data => {
                                globalres = data; // вызываем только после получения данных
                                console.log(globalres); // выводим уже присвоенное значение
                                window.location.href = "homepage.html";
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    })
                    .catch(error => {
                        console.error("Ошибка при получении данных:", error);
                        let chats = []
                        let num = newchats.length - 1
                        while (num > -1) {
                            chats.push({
                                target: newchats[num].target,
                                chatid: newchats[num].chatid
                            });
                            num--
                        }
                        let exportJson = JSON.stringify(chats)
                        fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_chats" + "&text=" + exportJson)
                            .then(response => response.text())
                            .then(data => {
                                globalres = data; // вызываем только после получения данных
                                console.log(globalres); // выводим уже присвоенное значение
                                window.location.href = "homepage.html";
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    });
            }
            // Загружаем новые чаты
            fetch("https://sebain.pythonanywhere.com/get?filename=newchats_" + pp)
                .then(response => response.text())
                .then(data => {
                    globalres = data; // вызываем только после получения данных
                    console.log(globalres); // выводим уже присвоенное значение
                    try {
                        let newchats = JSON.parse(globalres)
                        addchat(newchats)
                        fetch("https://sebain.pythonanywhere.com/set?filename=newchats_" + pp + "&text=voidblank1")
                            .then(response => response.text())
                            .then(data => {
                                globalres = data; // вызываем только после получения данных
                                console.log(globalres); // выводим уже присвоенное значение
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                    } catch {
                        console.log("Если это не джсон то там ничё нет")
                    }
                })
                .catch(error => {
                    console.error("Собственно если файла с чатами нет то зачем нам чтото делать ", error);
                });
            //Инитиализация
            function getRandomBrightColor() {
                const brightColors = [
                    'FF5733', 'FF8C00', 'FFD700', 'ADFF2F', '00FF7F', '00FFFF', '1E90FF', '4169E1',
                    '9932CC', 'FF69B4', 'FF1493', 'FF4500', '32CD32', '00CED1', 'DC143C', '8A2BE2',
                    'FF6347', 'FFA07A', 'FF7F50', 'FFB6C1', 'FA8072', 'F08080', 'F0E68C', 'EEE8AA',
                    'DAA520', 'B8860B', 'D2691E', 'CD5C5C', '8B0000', 'A52A2A', 'B22222', 'BC8F8F',
                    'FF00FF', '8B008B', '9400D3', 'BA55D3', '9370DB', '7B68EE', '6A5ACD', '483D8B',
                    '6495ED', '40E0D0', '48D1CC', '00BFFF', '87CEFA', '87CEEB', '4682B4', '5F9EA0',
                    '00FA9A', '00FF00', '7FFF00', '7CFC00', '32CD32', '98FB98', '90EE90', '8FBC8F',
                    '3CB371', '2E8B57', '228B22', '006400', '66CDAA', '20B2AA', '008B8B', '008080',
                    'B0E0E6', 'AFEEEE', 'ADD8E6', 'B0C4DE', '778899', '708090', 'BEBEBE', 'D3D3D3',
                    'C0C0C0', 'A9A9A9', '808080', '696969', '2F4F4F', '000000', 'FFFFFF', 'F5F5F5',
                    'FFE4B5', 'FFEBCD', 'FFF0F5', 'FFFACD', 'FAFAD2', 'FFEFD5', 'FFDAB9', 'E6E6FA',
                    'D8BFD8', 'DDA0DD', 'EE82EE', 'DA70D6', 'FF00FF', 'C71585', 'DB7093', 'FF1493',
                    'FF69B4', 'FFC0CB', 'FFA07A', 'FF7F50', 'FF6347', 'FF4500', 'FF8C00', 'FFA500',
                    'FFD700', 'FFFF00', 'FFFFE0', 'F0E68C', 'EEDD82', 'DAA520', 'BDB76B', 'B8860B'
                ];
                const randomIndex = Math.floor(Math.random() * brightColors.length);
                return brightColors[randomIndex];
            }


            function getRandomFromRange(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            window.addEventListener("resize", () => {
                idtext.position(5, window.innerHeight - 125)
                scradd.position(window.innerWidth - 155, window.innerHeight - 135)
                setts.position(window.innerWidth - 84, 15)
                overlay.size(windowWidth, windowHeight);
                updates.position(window.innerWidth - 300, window.innerHeight - 75)
                addbutton.position(window.innerWidth - 150, window.innerHeight - 75)
                let num = chatbuttons.length - 1
                while (num > -1) {
                    let tbutton = chatbuttons[num]
                    tbutton.size(window.innerWidth, 35)
                    let itbutton = chatimgs[num]
                    itbutton.position(window.innerWidth - 35, itbutton.position.y)
                    itbutton.size(35, 35)
                    num--

                }
            });
            noCanvas()

            function shortenText(text) {
                return text.length <= 50 ? text : text.slice(0, 50) + '..';
            }

            //Загрузка чатов
            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_chats")
                .then(response => response.text())
                .then(data => {
                    chatsJSON = data;
                    console.log(chatsJSON) // выводим уже присвоенное значение
                    let tchats = JSON.parse(chatsJSON)
                    let num = tchats.length - 1
                    let btnum = 0
                    let pos = 75
                    while (num > -1) {
                        let xpos = pos
                        let xbtnum = btnum
                        let xnum = num

                        fetch("https://sebain.pythonanywhere.com/saveget?filename=" + tchats[xnum].target + "_profn")
                            .then(response => response.text())
                            .then(data => {
                                let clr
                                let xid = tchats[xnum].chatid
                                let tbutton = createButton(data)
                                let xdata = data
                                tbutton.style('white-space', 'pre-wrap');
                                //tbutton.html("Текст")
                                tbutton.position(0, xpos)
                                tbutton.size(window.innerWidth, 35)
                                tbutton.style('border-radius', '8px');
                                tbutton.style('text-align', 'left');
                                tbutton.style('padding-left', '12px');
                                chatbuttons[xbtnum] = tbutton
                                tbutton.mousePressed(() => {
                                    setCookie2("chatid", xid)
                                    setCookie2("name", data)
                                    setCookie2("colour", clr)
                                    window.location.href = "chat.html";
                                });
                                let btn = createButton('');
                                getProfUrl(tchats[xnum].target, btn)
                                btn.style('background-size', 'cover');
                                btn.position(window.innerWidth - 35, xpos)
                                let pubk = tchats[xnum].target
                                btn.mousePressed(() => {
                                    overlay.style('background', 'rgba(0, 0, 0, 0.6)');
                                    overlay.style('z-index', '100');
                                    let fsimg = createButton('');
                                    fsimg.style('z-index', '101');
                                    getProfUrl(pubk, fsimg)
                                    fsimg.style('background-size', 'cover');
                                    fsimg.size(366, 366)
                                    fsimg.position(0, 0)
                                    fsimg.mousePressed(() => {
                                        fsimg.remove()
                                        overlay.style('background', '#ffffff');
                                        overlay.style('z-index', '-100');
                                    });
                                });
                                btn.size(35, 35)
                                chatimgs[xbtnum] = btn
                                fetch("https://sebain.pythonanywhere.com/get?filename=chat_" + xid)
                                    .then(response => response.text())
                                    .then(data => {
                                        let history_newJSON = data
                                        fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_oldchat" + xid)
                                            .then(response => response.text())
                                            .then(data => {
                                                data = Decrypt(data)
                                                let history_oldJSON = data
                                                let new1 = JSON.parse(history_newJSON)
                                                new1 = new1[new1.length - 1]
                                                let old1 = JSON.parse(history_oldJSON)
                                                console.log(JSON.stringify(new1))
                                                if (JSON.stringify(new1) == JSON.stringify(old1)) {
                                                    let history = JSON.parse(history_newJSON)
                                                    let l = history.length - 1
                                                    tbutton.html(xdata + " [ПОСЛЕДНЕЕ]\n" + shortenText(history[l].value))

                                                } else {
                                                    tbutton.html(xdata + " [НОВОЕ]")
                                                }
                                            })
                                            .catch(error => {
                                                console.error("Ошибка при получении данных:", error);
                                            });

                                    })
                                    .catch(error => {
                                        console.error("Ошибка при получении данных:", error);
                                    });
                                fetch("https://sebain.pythonanywhere.com/saveget?filename=" + tchats[xnum].target + "_colour")
                                    .then(response => response.text())
                                    .then(data => {
                                        console.log(data)
                                        if (data == "Файл не найден в save") {
                                            console.log("Не получен цвет" + tchats[xnum].target)
                                        } else {
                                            tbutton.style('background-color', "#" + data);
                                            clr = "#" + data
                                        }
                                    })
                                    .catch(error => {
                                        console.error(error)
                                    });
                            })
                            .catch(error => {
                                console.error("Ошибка при получении данных:", error);
                            });
                        pos = pos + 35
                        btnum++
                        num--
                    }
                })
                .catch(error => {
                    console.error("Ошибка при получении данных:", error);
                    alert("У вас нет ни одного чата??? Так добавь своего друга по его ID, если уже добавил или хочешь добавить жми ОК")
                });
            //Ник
            let mynik
            console.log(getRandomBrightColor())
            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_colour")
                .then(response => response.text())
                .then(data => {
                    let data5 = data
                    console.log(data)
                    if (data == "Файл не найден в save") {
                        crush
                    }

                    fetch("https://sebain.pythonanywhere.com/saveget?filename=" + pp + "_profn")
                        .then(response => response.text())
                        .then(data => {
                            mynik = createP(data)
                            mynik.style('background-color', "#" + data5);
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                            alert("Ошибка получения ника! Видно нет интернета!!!")
                        });


                })
                .catch(error => {
                    fetch("https://sebain.pythonanywhere.com/saveset?filename=" + ps + "_colour&text=" + getRandomBrightColor())
                        .then(response => response.text())
                        .then(data => {
                            globalres = data; // вызываем только после получения данных
                            console.log(globalres);
                            window.location.href = "homepage.html"; // выводим уже присвоенное значение
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                            alert("Проверьте интернет!!! Он возможно ламатый у вас!")
                        });
                });
            // Остальное 
            let updates = createButton("Список обновлений")
            updates.style('background-color', '#ff9933');
            updates.style('border-radius', '12px');
            updates.position(window.innerWidth - 300, window.innerHeight - 75)
            updates.mousePressed(() => {
                window.location.href = "update.html";
            });
            updates.style('position', 'fixed');
            updates.style('z-index', '101');
            let setts = createButton("Настройки")
            setts.style('background-color', '#cccccc');
            setts.style('border-radius', '12px');
            setts.position(window.innerWidth - 84, 15)
            setts.mousePressed(() => {
                window.location.href = "setts.html";
            });
            let scradd = createButton("Как установить наше приложение(всего 3 шага)")
            scradd.style('background-color', '#cccccc');
            scradd.style('border-radius', '12px');
            scradd.position(window.innerWidth - 155, window.innerHeight - 135)
            scradd.mousePressed(() => {
                // Картинка-фон
                let thismg = createButton("");
                thismg.parent(document.body);
                thismg.style('position', 'fixed');
                thismg.style('top', '0');
                thismg.style('left', '0');
                thismg.style('width', '100vw');
                thismg.style('height', '100vh');
                thismg.style('border', 'none');
                thismg.style('z-index', '9999');
                thismg.style('background-image', 'url("https://i.ibb.co/JwGpSP6k/how.jpg")');
                thismg.style('background-size', 'contain'); // сохраняет пропорции картинки
                thismg.style('background-position', 'center');
                thismg.style('background-repeat', 'no-repeat');
                thismg.style('background-color', '#000'); // на случай, если картинка не на весь экран

                // Кнопка закрытия — в левом верхнем углу
                let cbtn = createButton("✕");
                cbtn.parent(document.body);
                cbtn.style('position', 'fixed');
                cbtn.style('top', '15px');
                cbtn.style('left', '15px');
                cbtn.style('z-index', '10000');
                cbtn.style('padding', '10px 15px');
                cbtn.style('font-size', '18px');
                cbtn.style('background', '#fff');
                cbtn.style('border', '1px solid #000');
                cbtn.style('border-radius', '5px');
                cbtn.style('cursor', 'pointer');

                // Закрытие картинки и кнопки
                cbtn.mousePressed(() => {
                    thismg.remove();
                    cbtn.remove();
                });
            });
            scradd.style('position', 'fixed');
            scradd.style('z-index', '101');
            let idtext = createP("Ваш id:" + pp)
            idtext.position(5, window.innerHeight - 125)
            idtext.style('position', 'fixed');
            idtext.style('z-index', '101');
            idtext.style('background-color', "#ffffff");
            let addbutton = createButton("Добавить по ID")
            addbutton.style('background-color', '#339933');
            addbutton.style('border-radius', '12px');
            addbutton.position(window.innerWidth - 150, window.innerHeight - 75)
            addbutton.mousePressed(() => {
                let globalres = ""
                let addid = prompt("Введите id вашего собеседника")
                if (addid != pp || addid != "" || addid != "1") {
                    fetch("https://sebain.pythonanywhere.com/saveget?filename=" + addid + "_profn")
                        .then(response => response.text())
                        .then(data => { // вызываем только после получения данных

                            console.log(data);
                            if (data == "Файл не найден в save") {
                                alert("НЕВЕРНЫЙ ID")
                                window.href.location = "homepage.html"
                            }
                            let chatid = String(getRandomFromRange(11111, 99999))

                            function sent(chats, addid, chatid, pp) {
                                chats.push({
                                    target: pp,
                                    chatid: chatid
                                });

                                let targetJSON = JSON.stringify(chats)
                                let our = [{
                                    target: addid,
                                    chatid: chatid
                                }];
                                let ourJSON = JSON.stringify(our)
                                let placeholder = [{
                                    type: 'text',
                                    value: "Чтобы сообщения из этого чата приходили вам на почту: отправьте сюда любое сообщение",
                                    sender: "system",
                                    time: Math.floor(Date.now() / 1000)
                                }];
                                let placeholderJSON = JSON.stringify(placeholder)
                                fetch("https://sebain.pythonanywhere.com/set?filename=chat_" + chatid + "&text=" + placeholderJSON)
                                    .then(response => response.text())
                                    .then(data => {
                                        data = data
                                        fetch("https://sebain.pythonanywhere.com/set?filename=newchats_" + addid + "&text=" + targetJSON)
                                            .then(response => response.text())
                                            .then(data => {
                                                globalres = data;
                                                fetch("https://sebain.pythonanywhere.com/set?filename=newchats_" + pp + "&text=" + ourJSON)
                                                    .then(response => response.text())
                                                    .then(data => {
                                                        globalres = data; // выводим уже присвоенное значение
                                                        alert("Чат добавлен, успех!")
                                                        window.location.href = "homepage.html"
                                                    })
                                                    .catch(error => {
                                                        alert("АЛЁЁЁЁ, ВСЁ СЛАМАЛАСЯ")
                                                    }); // выводим уже присвоенное значение
                                            })
                                            .catch(error => {
                                                alert("АЛЁЁЁЁ, ВСЁ СЛАМАЛАСЯ")
                                            });
                                    })
                                    .catch(error => {
                                        alert("АЛЁЁЁЁ, ВСЁ СЛАМАЛАСЯ")
                                    });
                            }
                            fetch("https://sebain.pythonanywhere.com/get?filename=newchats_" + addid)
                                .then(response => response.text())
                                .then(data => {
                                    globalres = data;
                                    try {
                                        let chats = JSON.parse(globalres)
                                        sent(chats, addid, chatid, pp)
                                    } catch {
                                        console.log(error);
                                        let chats = []
                                        sent(chats, addid, chatid, pp)

                                    } // выводим уже присвоенное значение
                                })
                                .catch(error => {
                                    console.log(error)
                                    let chats = []
                                    sent(chats, addid, chatid, pp)
                                }); // выводим уже присвоенное значение
                        })
                        .catch(error => {
                            console.error("Ошибка при получении данных:", error);
                            alert("Не верный ID")
                            window.location.href = "homepage.html";
                        });
                } else {
                    alert("Не верный Id")
                }
            });
            addbutton.style('position', 'fixed');
            addbutton.style('z-index', '101');
        }
    </script>
    <!-- start webpushr code -->
    <script>
        function _webpushrScriptReady() {
            console.log(getCookie("ss"))
            webpushr('attributes', {
                "key1": "value",
                'user_id': getCookie("ss")
            });
        }
        (function(w, d, s, id) {
            if (typeof(w.webpushr) !== 'undefined') return;
            w.webpushr = w.webpushr || function() {
                (w.webpushr.q = w.webpushr.q || []).push(arguments)
            };
            var js, fjs = d.getElementsByTagName(s)[0];
            js = d.createElement(s);
            js.id = id;
            js.async = 1;
            js.src = "https://cdn.webpushr.com/app.min.js";
            fjs.parentNode.appendChild(js);
        }(window, document, 'script', 'webpushr-jssdk'));
        webpushr('setup', {
            'key': 'BFLe_7o4MjpBAJQqK9Zue9crqf0lRfNO6uipfd0w9HRPbZzy0QBIxTXezp_XTPdpXV_dvyDr6GjhTVZpvYlxiUc',
            'user_id': getCookie("ss")
        });
    </script>
    <!-- end webpushr code -->
</body>

</html>