<!DOCTYPE html>
<html lang="ru">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    html,
    body {
        overflow: hidden;
        margin: 0;
        padding: 0;
    }
</style>

<head>
    <meta charset="UTF-8" />
    <title>TheEM - –∑–≤–æ–Ω–æ–∫</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É p5.js –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ p5.dom -->

    <script src="libs/p5.js"></script>
    <script src="libs/xlibs.js"></script>
    <script src="call/gui.js"></script>
</head>

<body>
    <script>
        let mic = false
        let spk = true
        callers = []
        ocallers = []
        olds = new Map();
        objs = []
        callid = getCookie("callid")
        let ss = getCookie("ss")
        let pp = getCookie("pp");
        let ps = getCookie("ps")
        let b_mic_tips
        let b_spk_tips
        let b_end_tips
        let b_mic
        let b_spk
        let b_end
        let plsenmic
        let anim = false
        const globalAudioContext = new(window.AudioContext || window.webkitAudioContext)();
        if (getCookie("callid") == getCookie("travatrax418")) {
            window.location.href = "homepage.html"
        }

        function setup() {
            //sound.js
            function PlayRecord(record, speed = 0.92, volume = 4) {
                console.log(volume)
                console.log("üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É –∑–≤—É–∫...");

                try {
                    const audioData = Uint8Array.from(atob(record), c => c.charCodeAt(0));
                    globalAudioContext.decodeAudioData(audioData.buffer, buffer => {
                        const source = globalAudioContext.createBufferSource();
                        const gainNode = globalAudioContext.createGain();
                        const highpassFilter = globalAudioContext.createBiquadFilter();
                        const compressor = globalAudioContext.createDynamicsCompressor();

                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                        source.buffer = buffer;
                        source.playbackRate.value = speed;

                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                        gainNode.gain.value = Math.min(volume, 1.5); // –º–æ–∂–Ω–æ —á—É—Ç—å —É—Å–∏–ª–∏—Ç—å

                        // –§–∏–ª—å—Ç—Ä: —É–±–∏—Ä–∞–µ–º –Ω–∏–∑–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –Ω–∏–∂–µ 200 –ì—Ü
                        highpassFilter.type = "highpass";
                        highpassFilter.frequency.value = 200;

                        // –ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä: –¥–µ–ª–∞–µ—Ç —Ä–µ—á—å –±–æ–ª–µ–µ —Ä–æ–≤–Ω–æ–π
                        compressor.threshold.value = -50;
                        compressor.knee.value = 40;
                        compressor.ratio.value = 12;
                        compressor.attack.value = 0;
                        compressor.release.value = 0.25;

                        // –¶–µ–ø–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        source
                            .connect(highpassFilter)
                            .connect(compressor)
                            .connect(gainNode)
                            .connect(globalAudioContext.destination);

                        source.start();

                        source.onended = () => {
                            console.log("‚úÖ –ó–≤—É–∫ –∑–∞–≤–µ—Ä—à—ë–Ω");
                        };
                    }, error => {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ:", error);
                    });
                } catch (e) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ base64:", e);
                }
            }

            async function Record(millis) {
                console.log("üéôÔ∏è –ó–∞–ø–∏—Å—ã–≤–∞—é...");

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                const recordedChunks = [];

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm; codecs=opus',
                    audioBitsPerSecond: 96000 // –º–æ–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
                });

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const t0 = performance.now();

                    const blob = new Blob(recordedChunks, {
                        type: 'audio/webm'
                    });
                    const reader = new FileReader();

                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        const t1 = performance.now();
                        console.log(`üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ –∑–∞–Ω—è–ª–∞ ${Math.round(t1 - t0)} –º—Å`);
                        After(base64Audio);

                    };

                    reader.readAsDataURL(blob);
                };

                mediaRecorder.start();

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∑–∞–ø–∏—Å—å –∑–∞ 100 –º—Å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π
                setTimeout(() => {
                    Record(millis); // —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤
                }, millis - 1);

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å
                setTimeout(() => {
                    mediaRecorder.stop();
                }, millis);
            }

            async function requestMicrophone() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: true
                    });
                    console.log("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω");
                    // –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å stream –¥–ª—è –∑–∞–ø–∏—Å–∏
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", err);
                    alert("–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è —Ä–∞–±–æ—Ç—ã");
                }
            }
            //–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤—ã–∑–æ–≤—É
            function inviteme(arr) {
                arr = arr.filter(item => item !== pp)
                arr.push(pp)
                fetch('https://sebain.pythonanywhere.com/call_set_post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filename: callid,
                            text: JSON.stringify(arr)
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                        }
                        return response.text(); // –∏–ª–∏ .json(), –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
                    })
                    .then(data => {
                        console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                        console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ!")
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                    });
            }
            fetch('https://sebain.pythonanywhere.com/call_get_post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: callid
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                    }
                    return response.text(); // –∏–ª–∏ .json(), –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
                })
                .then(data => {
                    console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                    if (data == "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ calls") {
                        data = []
                        callers = data
                        inviteme(data)
                    } else {
                        data = JSON.parse(data)
                        callers = data
                        inviteme(data)
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                });
            //–ö–ª–∏–µ–Ω—Ç—Å–∞—è —á–∞—Å—Ç—å
            noCanvas()
            window.addEventListener("resize", () => {
                updategui()
            });

            b_mic = createButton("")
            b_spk = createButton("")
            b_end = createButton("")

            b_end.mousePressed(() => {
                callers = callers.filter(item => item !== pp)
                fetch('https://sebain.pythonanywhere.com/call_set_post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filename: callid,
                            text: JSON.stringify(callers)
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                        }
                        return response.text(); // –∏–ª–∏ .json(), –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
                    })
                    .then(data => {
                        console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                        window.location.href = "chat.html"
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                    });
            });

            b_mic_tips = createButton("–ú–∏–∫—Ä–æ (–≤—ã–∫–ª)")
            b_spk_tips = createButton("–î–∏–Ω–∞–º (–≤–∫–ª)")
            b_end_tips = createButton("–ó–∞–≤–µ—Ä—à")
            crtgui()
            updategui()
            requestMicrophone()
            setInterval(() => {
                console.log("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
                if (mic) {
                    b_mic.style('background-image', 'url("/call/mic_en.png")')
                    b_mic_tips.html("–ú–∏–∫—Ä–æ (–≤–∫–ª)");
                } else {
                    b_mic.style('background-image', 'url("/call/mic_di.png")')
                    b_mic_tips.html("–ú–∏–∫—Ä–æ (–≤—ã–∫–ª)");
                }
                if (spk) {
                    b_spk.style('background-image', 'url("/call/sound_en.png")')
                    b_spk_tips.html("–î–∏–Ω–∞–º (–≤–∫–ª)");
                } else {
                    b_spk.style('background-image', 'url("/call/sound_di.png")')
                    b_spk_tips.html("–î–∏–Ω–∞–º (–≤—ã–∫–ª)");
                }
                if (!mic) {
                    if (anim) {
                        anim = !anim
                        plsenmic.style('color', '#f00');
                    } else {
                        anim = !anim
                        plsenmic.style('color', '#000');
                    }
                } else {
                    plsenmic.style('color', '#000');
                }
                try {
                    fetch('https://sebain.pythonanywhere.com/call_get_post', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filename: callid
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                            }
                            return response.text(); // –∏–ª–∏ .json(), –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
                        })
                        .then(data => {
                            console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                            if (data == "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ calls") {} else {
                                data = JSON.parse(data)
                                callers = data
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                        });
                } catch {
                    console.log("–ù–ï –ó–ê–ì–†–£–ñ–ï–ù –°–ü–ò–°–û–ö")
                }
                //–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–∞—Å–Ω–∏–∫–æ–≤
                if (callers.length != ocallers.length) {
                    mn = objs.length - 1
                    while (mn > -1) {
                        objs[mn].remove()
                        mn--
                    }
                    console.log("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ!!++");
                    console.log(callers)
                    let y = 50;
                    ocallers = callers;
                    num = callers.length - 1
                    console.log("num:", num);
                    console.log("–í—Å—ë –≥—É–¥")
                    while (num > -1) {

                        print('–≠–ª–µ–º–µ–Ω—Ç ' + num + ': ' + callers[num]);

                        let xy = y; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –î–û fetch
                        let xnum = num
                        let caller = callers[xnum]

                        if (callers[xnum] != pp) {
                            fetch("https://sebain.pythonanywhere.com/saveget?filename=" + caller + "_profn")
                                .then(response => response.text())
                                .then(data => {
                                    let btn = createButton(data);
                                    btn.style('background-color', '#000');
                                    btn.style('color', '#fff');
                                    btn.style("border-width", "0px");
                                    btn.position(0, xy);
                                    btn.size(100, 25);
                                    objs.push(btn)
                                        //if (olds.get(caller + "_xchk") != "yes") {
                                    olds.set(caller + "_xchk", "yes")
                                    let slider = createSlider(0, 10, 5, 1);
                                    slider.size(90, 25)
                                    slider.position(100, xy)
                                    objs.push(slider)
                                    olds.set(caller + "_vol", slider)
                                    console.log(caller + "_vol")
                                        //}
                                })
                                .catch(error => {
                                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                                });

                            y += 25; // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ fetch
                        }

                        num--
                    }

                }


            }, 800);

            //–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–≤—É–∫–∞

            Record(500)

            function After(record) {
                //–ó–∞–ø–∏—Å—å
                //Record(600)
                if (mic) {
                    fetch('https://sebain.pythonanywhere.com/call_set_post', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filename: callid + "_" + pp,
                                text: record
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
                            }
                            return response.text(); // –∏–ª–∏ .json(), –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
                        })
                        .then(data => {
                            console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                        });
                }
                console.log("–¶–∏–∫–ª: –ø–∏–ø!");
                //–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                console.log(callers)
                console.log(1)
                let num = callers.length - 1;

                while (num > -1) {
                    let currentCaller = callers[num];

                    if (typeof currentCaller !== 'undefined' && currentCaller !== pp && spk) {
                        fetch('https://sebain.pythonanywhere.com/call_get_post', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    filename: callid + "_" + currentCaller
                                })
                            })
                            .then(response => response.text())
                            .then(data => {
                                let slider = olds.get(currentCaller + "_vol");
                                if (slider && olds.get(currentCaller) !== data) {
                                    PlayRecord(data, 0.92, slider.value() / 10);
                                    olds.set(currentCaller, data);
                                }
                            })
                            .catch(error => {
                                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                            });
                    }

                    num--;
                }

            }





        }
    </script>
</body>

</html>